name: Harvest Intelligence Data

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  workflow_dispatch: # Allow manual trigger

env:
  FETCH_TIMEOUT: 20
  MAX_RETRIES: 3
  STALE_THRESHOLD: 24

jobs:
  harvest:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Run intelligence harvester
        id: harvest
        run: |
          set +e  # Don't exit on error
          python scripts/update_intel.py
          exit_code=$?
          echo "exit_code=$exit_code" >> $GITHUB_OUTPUT

          # Exit code 2 means critical errors but data was still saved
          if [ $exit_code -eq 2 ]; then
            echo "::warning::Harvest completed with critical errors"
          elif [ $exit_code -ne 0 ]; then
            echo "::error::Harvest failed completely"
            exit $exit_code
          fi

      - name: Validate output file
        run: |
          if [ ! -f data/intel_snapshot.json ]; then
            echo "::error::Output file not created"
            exit 1
          fi

          # Validate JSON is parseable
          python -c "import json; json.load(open('data/intel_snapshot.json'))" || {
            echo "::error::Output file is not valid JSON"
            exit 1
          }

          # Check for required fields
          python -c "
          import json
          import sys

          with open('data/intel_snapshot.json') as f:
              data = json.load(f)

          required = ['last_updated', 'macro', 'peers', 'suppliers']
          missing = [f for f in required if f not in data]
          if missing:
              print(f'::error::Missing required fields: {missing}')
              sys.exit(1)

          # Check pillar statuses
          for pillar in ['macro', 'peers', 'suppliers']:
              status = data.get(pillar, {}).get('status', 'unknown')
              rag = data.get(pillar, {}).get('rag_score', 'UNKNOWN')
              print(f'{pillar}: {status} ({rag})')

          # Print harvest stats if available
          stats = data.get('harvest_stats', {})
          if stats:
              print(f\"Errors: {stats.get('total_errors', 0)}, Warnings: {stats.get('total_warnings', 0)}, Duration: {stats.get('duration_seconds', 0):.2f}s\")
          "

      - name: Commit and push if changed
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/intel_snapshot.json data/intel_snapshot.backup.json 2>/dev/null || git add data/intel_snapshot.json

          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Update intelligence data [skip ci]

          Harvest Stats:
          - Exit code: ${{ steps.harvest.outputs.exit_code }}
          - Timestamp: $(date -u +%Y-%m-%dT%H:%M:%SZ)"
            git push
          fi

      - name: Report harvest status
        if: always()
        run: |
          if [ "${{ steps.harvest.outputs.exit_code }}" = "2" ]; then
            echo "::warning title=Partial Success::Intelligence harvest completed with some errors. Check logs for details."
          elif [ "${{ steps.harvest.outputs.exit_code }}" = "0" ]; then
            echo "::notice title=Success::Intelligence harvest completed successfully."
          else
            echo "::error title=Failure::Intelligence harvest failed. Manual intervention may be required."
          fi

